<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geography Ch 29 New Words</title>
<style>
  body {
    font-family: sans-serif;
    background: #f0f8ff;
    text-align: center;
    padding: 20px;
  }
  .hidden { display: none; }
  #game-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    max-width: 600px;
    margin: 20px auto;
  }
  .card {
    position: relative;
    width: 100%;
    height: 90px;
    cursor: pointer;
    perspective: 600px;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.4s;
    transform-style: preserve-3d;
  }
  .card.flipped .card-inner {
    transform: rotateY(180deg);
  }
  .card .front, .card .back {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    backface-visibility: hidden;
    box-sizing: border-box;
    padding: 10px;
    font-size: 18px;
    user-select: none;
  }
  .card .front {
    background: #4682b4;
    color: white;
  }
  .card .back {
    background: #fff;
    color: #000;
    transform: rotateY(180deg);
  }
  @keyframes shake {
    0% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-8px); }
    80% { transform: translateX(8px); }
    100% { transform: translateX(0); }
  }
  .shake {
    animation: shake 0.5s;
  }
  #score-board {
    margin-top: 20px;
    font-weight: bold;
  }
  input, button {
    padding: 10px;
    font-size: 16px;
    margin: 5px;
  }
  #example-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffffff;
    color: #222222;
    border: 2px solid #4682b4;
    border-radius: 12px;
    padding: 20px;
    max-width: 80%;
    box-shadow: 0 4px 15px rgba(70, 130, 180, 0.4);
    font-size: 18px;
    display: none;
    z-index: 10;
  }
  #example-popup button {
    margin-top: 15px;
    padding: 8px 15px;
    font-size: 16px;
    cursor: pointer;
  }
  #game-over {
    max-width: 600px;
    margin: 30px auto;
    background: #e1f0ff;
    border: 2px solid #4682b4;
    border-radius: 12px;
    padding: 20px;
    font-size: 20px;
    display: none;
  }
</style>
</head>
<body>
<h1>JH Geography Ch 29 Vocabulary Memory Game</h1>

<div id="start-screen">
  <p>Enter your nickname:</p>
  <input type="text" id="nickname" autocomplete="off" />
  <button onclick="startGame()">Start Game</button>
</div>

<div id="game-screen" class="hidden">
  <h2 id="level-title"></h2>
  <div id="game-board"></div>
  <div id="score-board"></div>
  <button onclick="retryLevel()">Retry Level</button>
  <button onclick="nextLevel()">Next Level</button>
</div>

<div id="example-popup">
  <div id="example-text"></div>
  <button onclick="closeExample()">Close</button>
</div>

<div id="game-over"></div>

<script>
  const levels = [4, 6, 8, 10];
  const wordPairs = [
    ['free trade', '自由貿易'],
    ['agreement', '協定'],
    ['mountain range', '山脈'],
    ['flat land', '平地'],
    ['hurricane', 'ハリケーン'],
    ['tropical storm', '熱帯低気圧'],
    ['damage', '被害'],
    ['satellite', '人工衛星'],
    ['measure', '測定する'],
    ['wind speed', '風速'],
    ['air pressure', '気圧'],
    ['warn', '警告する']
  ];
  const exampleSentences = {
    "free trade": "Free trade allows countries to buy and sell goods without many taxes.",
    agreement: "They signed an agreement to work together.",
    "mountain range": "The mountain range is covered with snow in winter.",
    "flat land": "The flat land is good for farming.",
    hurricane: "The hurricane caused a lot of damage last year.",
    "tropical storm": "The tropical storm is moving toward the coast.",
    damage: "The storm did a lot of damage to the buildings.",
    satellite: "The artificial satellite orbits the Earth every 90 minutes.",
    measure: "We need to measure the temperature carefully.",
    "wind speed": "The wind speed is very high today.",
    "air pressure": "Air pressure affects the weather.",
    warn: "The weather service will warn us if there is a storm."
  };
  const encouragingMessages = [
    "Great job!", "Well done!", "Keep it up!", "Nice match!",
    "Excellent!", "You're doing great!", "Fantastic!", "Awesome!",
    "You're a star!", "Perfect!"
  ];

  let level = 0;
  let nickname = '';
  let gameWords = [];
  let flippedCards = [];
  let matched = 0;
  let wrongAttempts = 0;
  let gameStartTime = 0;

  function startGame() {
    nickname = document.getElementById('nickname').value.trim();
    if (!nickname) return alert('Please enter a nickname');
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('game-screen').classList.remove('hidden');
    level = 0;
    gameStartTime = Date.now();
    loadLevel();
  }

  function shuffleArray(arr) {
    for (let i = arr.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function loadLevel() {
    document.getElementById('level-title').textContent = `Level ${level + 1}`;
    const board = document.getElementById('game-board');
    board.innerHTML = '';
    flippedCards = [];
    matched = 0;
    wrongAttempts = 0;

    let selectedPairs = wordPairs.slice(0, levels[level]);
    shuffleArray(selectedPairs);

    gameWords = [];
    selectedPairs.forEach(pair => {
      gameWords.push({ text: pair[0], pair: pair[1] });
      gameWords.push({ text: pair[1], pair: pair[0] });
    });

    shuffleArray(gameWords);

    gameWords.forEach(cardObj => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.text = cardObj.text;
      card.dataset.pair = cardObj.pair;

      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';

      const front = document.createElement('div');
      front.className = 'front';
      front.textContent = '';

      const back = document.createElement('div');
      back.className = 'back';
      back.textContent = cardObj.text;

      cardInner.appendChild(front);
      cardInner.appendChild(back);
      card.appendChild(cardInner);

      card.onclick = () => flipCard(card);
      board.appendChild(card);
    });

    document.getElementById('score-board').textContent = '';
  }

  function flipCard(card) {
    if (card.classList.contains('flipped') || flippedCards.length === 2) return;

    card.classList.add('flipped');
    flippedCards.push(card);

    if (flippedCards.length === 2) {
      const [c1, c2] = flippedCards;

      if (c1.dataset.pair === c2.dataset.text) {
        matched++;

        setTimeout(() => {
          showEncouragingMessage();
          showExampleSentence(c1.dataset.text);
        }, 500);

        flippedCards = [];

        if (matched === levels[level]) {
          const score = Math.max(0, 100 - wrongAttempts * 2);
          document.getElementById('score-board').textContent = `Well done, ${nickname}! Score: ${score}`;
        }
      } else {
        wrongAttempts++;

        c1.classList.add('shake');
        c2.classList.add('shake');

        setTimeout(() => {
          c1.classList.remove('shake');
          c2.classList.remove('shake');
          c1.classList.remove('flipped');
          c2.classList.remove('flipped');
          flippedCards = [];
        }, 1000);
      }
    }
  }

  function showEncouragingMessage() {
    const msg = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
    const scoreBoard = document.getElementById('score-board');
    scoreBoard.textContent = msg;
    setTimeout(() => {
      if (matched === levels[level]) {
        const score = Math.max(0, 100 - wrongAttempts * 2);
        scoreBoard.textContent = `Well done, ${nickname}! Score: ${score}`;
      } else {
        scoreBoard.textContent = '';
      }
    }, 2500);
  }

  function showExampleSentence(word) {
    if (!exampleSentences[word]) return;

    const popup = document.getElementById('example-popup');
    const textElem = document.getElementById('example-text');
    textElem.textContent = `"${word}": ${exampleSentences[word]}`;
    popup.style.display = 'block';
  }

  function closeExample() {
    document.getElementById('example-popup').style.display = 'none';
  }

  function retryLevel() {
    loadLevel();
  }

  function nextLevel() {
    if (matched !== levels[level]) {
      alert('Please find all matches before continuing.');
      return;
    }
    if (level < levels.length - 1) {
      level++;
      loadLevel();
    } else {
      endGame();
    }
  }

  function endGame() {
    const gameScreen = document.getElementById('game-screen');
    const gameOver = document.getElementById('game-over');

    gameScreen.classList.add('hidden');

    const totalTimeMs = Date.now() - gameStartTime;
    const totalSeconds = Math.floor(totalTimeMs / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    const now = new Date();
    const dateString = now.toLocaleString();

    // Calculate final score (average or last level’s score)
    const finalScore = Math.max(0, 100 - wrongAttempts * 2);

    gameOver.innerHTML = `
      <h2>Game Over!</h2>
      <p><strong>Nickname:</strong> ${nickname}</p>
      <p><strong>Final Score:</strong> ${finalScore}</p>
      <p><strong>Date & Time:</strong> ${dateString}</p>
      <p><strong>Total Time Played:</strong> ${minutes} min ${seconds} sec</p>
      <button onclick="restartGame()">Play Again</button>
    `;
    gameOver.style.display = 'block';
  }

  function restartGame() {
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('start-screen').classList.remove('hidden');
  }
</script>
</body>
</html>
